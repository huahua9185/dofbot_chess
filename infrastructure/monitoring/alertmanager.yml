# AlertManagerå‘Šè­¦é…ç½®
# æ™ºèƒ½è±¡æ£‹æœºå™¨äººå‘Šè­¦é€šçŸ¥ç³»ç»Ÿ

global:
  # å…¨å±€SMTPé…ç½®
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'chess-robot-alerts@gmail.com'
  smtp_auth_username: 'chess-robot-alerts@gmail.com'
  smtp_auth_password: 'your-app-password'
  smtp_require_tls: true

  # å…¨å±€é…ç½®
  resolve_timeout: 5m
  http_config:
    tls_config:
      insecure_skip_verify: true

# è·¯ç”±è§„åˆ™
route:
  group_by: ['severity', 'service']
  group_wait: 10s      # ç­‰å¾…æ—¶é—´ï¼Œæ”¶é›†åŒç»„å‘Šè­¦
  group_interval: 10s  # åŒç»„å†…å‘Šè­¦å‘é€é—´éš”
  repeat_interval: 1h  # é‡å¤å‘Šè­¦é—´éš”
  receiver: 'default'  # é»˜è®¤æ¥æ”¶è€…

  # å­è·¯ç”±è§„åˆ™
  routes:
    # ä¸¥é‡å‘Šè­¦ç«‹å³å‘é€
    - match:
        severity: critical
      receiver: 'critical-alerts'
      group_wait: 0s
      group_interval: 5s
      repeat_interval: 15m

    # ç³»ç»Ÿå‘Šè­¦
    - match:
        service: system
      receiver: 'system-alerts'
      group_interval: 30s
      repeat_interval: 2h

    # æœåŠ¡å‘Šè­¦
    - match_re:
        service: '(vision_service|robot_service|ai_service)'
      receiver: 'service-alerts'
      group_interval: 15s
      repeat_interval: 1h

    # æ•°æ®åº“å‘Šè­¦
    - match_re:
        service: '(redis|mongodb)'
      receiver: 'database-alerts'
      group_interval: 30s
      repeat_interval: 2h

    # ç¡¬ä»¶å‘Šè­¦
    - match:
        service: hardware
      receiver: 'hardware-alerts'
      group_wait: 5s
      group_interval: 10s
      repeat_interval: 30m

# æŠ‘åˆ¶è§„åˆ™
inhibit_rules:
  # å¦‚æœæœåŠ¡ä¸‹çº¿ï¼ŒæŠ‘åˆ¶å…¶ä»–ç›¸å…³å‘Šè­¦
  - source_match:
      alertname: 'ServiceDown'
    target_match_re:
      service: '.*'
    equal: ['instance']

  # å¦‚æœCPUä½¿ç”¨ç‡è¿‡é«˜ï¼ŒæŠ‘åˆ¶å†…å­˜å‘Šè­¦
  - source_match:
      alertname: 'HighCPUUsage'
    target_match:
      alertname: 'HighMemoryUsage'
    equal: ['instance']

# æ¥æ”¶è€…é…ç½®
receivers:
  # é»˜è®¤æ¥æ”¶è€…
  - name: 'default'
    webhook_configs:
      - url: 'http://localhost:8000/api/alerts/webhook'
        send_resolved: true
        http_config:
          tls_config:
            insecure_skip_verify: true

  # ä¸¥é‡å‘Šè­¦æ¥æ”¶è€…
  - name: 'critical-alerts'
    email_configs:
      - to: 'admin@chessrobot.local'
        subject: 'ğŸš¨ ä¸¥é‡å‘Šè­¦ - è±¡æ£‹æœºå™¨äººç³»ç»Ÿ'
        body: |
          ä¸¥é‡å‘Šè­¦è§¦å‘ï¼

          å‘Šè­¦åç§°: {{ .GroupLabels.alertname }}
          æœåŠ¡: {{ .GroupLabels.service }}
          ä¸¥é‡ç¨‹åº¦: {{ .GroupLabels.severity }}

          è¯¦ç»†ä¿¡æ¯:
          {{ range .Alerts }}
          - å‘Šè­¦: {{ .Annotations.summary }}
          - æè¿°: {{ .Annotations.description }}
          - å®ä¾‹: {{ .Labels.instance }}
          - æ—¶é—´: {{ .StartsAt.Format "2006-01-02 15:04:05" }}
          {{ end }}

          è¯·ç«‹å³æ£€æŸ¥ç³»ç»ŸçŠ¶æ€ï¼
        headers:
          Subject: 'ğŸš¨ è±¡æ£‹æœºå™¨äººä¸¥é‡å‘Šè­¦'

    webhook_configs:
      - url: 'http://localhost:8000/api/alerts/critical'
        send_resolved: true

    # çŸ­ä¿¡é€šçŸ¥ (éœ€è¦é…ç½®çŸ­ä¿¡æœåŠ¡)
    # sms_configs:
    #   - api_url: 'https://api.sms-service.com/send'
    #     to: '+86138xxxxxxxx'
    #     message: 'è±¡æ£‹æœºå™¨äººä¸¥é‡å‘Šè­¦: {{ .GroupLabels.alertname }}'

  # ç³»ç»Ÿå‘Šè­¦æ¥æ”¶è€…
  - name: 'system-alerts'
    email_configs:
      - to: 'sysadmin@chessrobot.local'
        subject: 'âš ï¸ ç³»ç»Ÿå‘Šè­¦ - {{ .GroupLabels.alertname }}'
        body: |
          ç³»ç»Ÿå‘Šè­¦é€šçŸ¥

          å‘Šè­¦: {{ .GroupLabels.alertname }}
          æœåŠ¡å™¨: {{ .GroupLabels.instance }}

          {{ range .Alerts }}
          - {{ .Annotations.summary }}
          - {{ .Annotations.description }}
          {{ end }}

          æ—¶é—´: {{ .CommonLabels.alertname }}

    webhook_configs:
      - url: 'http://localhost:8000/api/alerts/system'
        send_resolved: true

  # æœåŠ¡å‘Šè­¦æ¥æ”¶è€…
  - name: 'service-alerts'
    email_configs:
      - to: 'developer@chessrobot.local'
        subject: 'ğŸ”§ æœåŠ¡å‘Šè­¦ - {{ .GroupLabels.service }}'
        body: |
          æœåŠ¡å‘Šè­¦é€šçŸ¥

          æœåŠ¡: {{ .GroupLabels.service }}
          å‘Šè­¦: {{ .GroupLabels.alertname }}

          {{ range .Alerts }}
          - {{ .Annotations.summary }}
          - {{ .Annotations.description }}
          - å®ä¾‹: {{ .Labels.instance }}
          {{ end }}

    webhook_configs:
      - url: 'http://localhost:8000/api/alerts/service'
        send_resolved: true

    # Slacké€šçŸ¥ (éœ€è¦é…ç½®Slack webhook)
    # slack_configs:
    #   - api_url: 'https://hooks.slack.com/services/YOUR/SLACK/WEBHOOK'
    #     channel: '#alerts'
    #     title: 'æœåŠ¡å‘Šè­¦ - {{ .GroupLabels.service }}'
    #     text: '{{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'

  # æ•°æ®åº“å‘Šè­¦æ¥æ”¶è€…
  - name: 'database-alerts'
    email_configs:
      - to: 'dba@chessrobot.local'
        subject: 'ğŸ’¾ æ•°æ®åº“å‘Šè­¦ - {{ .GroupLabels.service }}'
        body: |
          æ•°æ®åº“å‘Šè­¦é€šçŸ¥

          æ•°æ®åº“: {{ .GroupLabels.service }}
          å‘Šè­¦: {{ .GroupLabels.alertname }}

          {{ range .Alerts }}
          - {{ .Annotations.summary }}
          - {{ .Annotations.description }}
          {{ end }}

    webhook_configs:
      - url: 'http://localhost:8000/api/alerts/database'
        send_resolved: true

  # ç¡¬ä»¶å‘Šè­¦æ¥æ”¶è€…
  - name: 'hardware-alerts'
    email_configs:
      - to: 'hardware@chessrobot.local'
        subject: 'ğŸ”© ç¡¬ä»¶å‘Šè­¦ - {{ .GroupLabels.alertname }}'
        body: |
          ç¡¬ä»¶è®¾å¤‡å‘Šè­¦

          è®¾å¤‡: {{ .CommonLabels.device }}
          å‘Šè­¦: {{ .GroupLabels.alertname }}

          {{ range .Alerts }}
          - {{ .Annotations.summary }}
          - {{ .Annotations.description }}
          {{ end }}

          è¯·æ£€æŸ¥ç¡¬ä»¶è®¾å¤‡çŠ¶æ€ï¼

    webhook_configs:
      - url: 'http://localhost:8000/api/alerts/hardware'
        send_resolved: true

# æ¨¡æ¿é…ç½®
templates:
  - '/etc/alertmanager/templates/*.tmpl'